---
name: Validate GenTx Files

on:
  pull_request:
    paths:
      - 'mainnet/gentx/*.json'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to validate (mainnet only)'
        required: false
        default: 'mainnet'

env:
  WARDEND_VERSION: 'v0.7.0-rc3'
  GO_VERSION: '1.24'

jobs:
  validate-gentx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dagger CLI
        run: |
          curl -fsSL https://dl.dagger.io/dagger/install.sh | BIN_DIR=/usr/local/bin sudo -E sh

      - name: Run GenTx validation with Dagger
        id: validation
        run: |
          # Determine network (default to mainnet if not specified)
          NETWORK="${{ github.event.inputs.network || 'mainnet' }}"
          echo "network=$NETWORK" >> $GITHUB_OUTPUT
          
          # Run the Dagger validation
          echo "Running GenTx validation for network: $NETWORK"
          
          # Capture the validation result
          if dagger call validate-gentx \
            --source . \
            --network "$NETWORK" \
            --wardend-version "$WARDEND_VERSION" \
            --go-version "$GO_VERSION"; then
            echo "validation_status=success" >> $GITHUB_OUTPUT
          else
            echo "validation_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run local validation output for logs
        if: always()
        run: |
          echo "=== Detailed Validation Results ==="
          dagger call run-local-validation \
            --source . \
            --network "${{ steps.validation.outputs.network }}" \
            --wardend-version "$WARDEND_VERSION" \
            --go-version "$GO_VERSION" || true

      - name: Comment on PR (Success)
        if: >
          github.event_name == 'pull_request' && 
          steps.validation.outputs.validation_status == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const network = '${{ steps.validation.outputs.network }}';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('GenTx Validation Results')
            );

            const commentBody = `## ‚úÖ GenTx Validation Results

            **Status**: ‚úÖ **ALL PASSED**
            **Network**: ${network}
            **Validation Tool**: Dagger CI

            All GenTx files have been successfully validated using Dagger!

            ---
            <sub>ü§ñ Auto-generated by Dagger GenTx validation</sub>`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Comment on PR (Failure)
        if: >
          github.event_name == 'pull_request' && 
          steps.validation.outputs.validation_status == 'failed'
        uses: actions/github-script@v6
        with:
          script: |
            const network = '${{ steps.validation.outputs.network }}';
            const baseUrl = context.payload.repository.html_url;
            const runUrl = `${baseUrl}/actions/runs/${context.runId}`;

            const commentBody = `## ‚ùå GenTx Validation Results

            **Status**: ‚ùå **FAILED**
            **Network**: ${network}
            **Validation Tool**: Dagger CI

            One or more GenTx files failed validation.
            Check the logs for details: [View Workflow Run](${runUrl})

            Common issues to check:
            - Insufficient fees (minimum: 1.8e17 award)
            - Invalid JSON format
            - Missing required fields
            - Network configuration mismatch

            To run validation locally:
            \`\`\`bash
            dagger call run-local-validation --source . --network ${network}
            \`\`\`

            ---
            <sub>ü§ñ Auto-generated by Dagger GenTx validation</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: Test check-genesis tool build
        if: always()
        run: |
          echo "=== Testing check-genesis tool build ==="
          dagger call test-check-genesis-tool \
            --source . \
            --go-version "$GO_VERSION" || true
